#!/bin/bash
# Pre-commit hook: block commits containing secrets/PII

PATTERNS=(
    'sk-ant-'
    'sk-[a-zA-Z0-9]{20,}'
    'AKIA[A-Z0-9]{16}'        # AWS access key
    'auth_token=[a-f0-9]{30,}'
    'password\s*[:=]\s*["\x27][^"\x27]+'
    '\+1[0-9]{10}'             # US phone numbers
)

STAGED=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED" ]; then
    exit 0
fi

for pattern in "${PATTERNS[@]}"; do
    MATCHES=$(echo "$STAGED" | xargs grep -lE "$pattern" 2>/dev/null)
    if [ -n "$MATCHES" ]; then
        echo "ðŸš¨ BLOCKED: Potential secret/PII detected!"
        echo "Pattern: $pattern"
        echo "Files: $MATCHES"
        echo ""
        echo "If this is a false positive, use: git commit --no-verify"
        exit 1
    fi
done

exit 0
